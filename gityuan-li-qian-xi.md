# Git原理浅析

让我们自己来设计版本管理工具，无外乎如下两块：

> 工作区 -> 远程仓库

但如果支持分布式，需要添加一个本地仓库。即

> 工作区 -> 本地仓库 -> 远程仓库

同时，为了支持能够实现部分提交，且不在工作区创建状态问题件污染工作区、满足暂存记录文件的信息等需要，我们需要在工作区与本地仓库之间增加一个暂存区，即：

> 工作区 -> 暂存区 -> 本地仓库 -> 远程仓库

这就是Git设计的基本骨架了。

## 1. 快照

首先，你可能会问，本地仓库在哪？

我们使用命令`git init`或`git clone`等就会创建本地仓库（Repository），即工作区目录下的`.git`文件夹。

我们再来看下什么是快照？

![](/assets/snapshot-version-01.png)

这是项目的三个版本，版本1中有两个文件A和B，然后修改了A，变成了A1，形成了版本2，接着又修改了B变为B1，形成了版本3。

如果我们把项目的每个版本都保存到本地仓库，需要保存至少6个文件，而实际上，只有4个不同的文件，A、A1、B、B1。为了节省存储的空间，我们要像一个方法将同样的文件只需要保存一份。这就引入了[Sha-1算法](https://en.wikipedia.org/wiki/SHA-1)。

可以使用git命令计算文件的 sha-1 值。

```bash
echo 'test content' | git hash-object --stdin
d670460b4b4aece5915caf5c68d12f560a9fe3e4
```
SHA-1将文件中的内容通过通过计算生成一个` 40 `位长度的hash值。

Sha-1的非常有特点：

- 由文件内容计算出的hash值
- hash值相同，文件内容相同

对于上图中的内容，无论我们执行多少次，都会得到相同的结果。因此，文件的sha-1值是可以作为文件的唯一` id `。同时，它还有一个额外的功能，校验文件完整性。

有了 sha-1 的帮助，我们可以对项目版本的存储方式做一下调整。

![](/assets/snapshot-sha-1.png)

上图与.git下的文件实际存储结构一致。

我们可以看到，在 `objects `目录下，存放了很多文件，他们都使用 sha-1 的前两位创建了文件夹，剩下的38位为文件名。我们先称呼这些文件为 `obj `文件。

对于这么多的 obj 文件，就保存了我们代码提交的所有记录。对于这些 obj 文件，其实分为四种类型，分别是 blob、tree、commit、tag。接下来，我们分别来看一下。

1. blob
 首先 A、A1、B、B1 就是 blob 类型的 obj。
 blob: 用来存放项目文件的内容，但是不包括文件的路径、名字、格式等其它描述信息。项目的任意文件的任意版本都是以blob的形式存放的。

2. tree
 tree 用来表示目录。我们知道项目就是一个目录，目录中有文件、有子目录。因此 tree 中有 blob、子tree，且都是使用 sha-1值引用的。这是与目录对应的。从顶层的 tree 纵览整个树状的结构，叶子结点就是blob，表示文件的内容，非叶子结点表示项目的目录，顶层的 tree 对象就代表了当前项目的快照。

3. commit
 commit: 表示一次提交，有parent字段，用来引用父提交。指向了一个顶层 tree，表示了项目的快照，还有一些其它的信息，比如上一个提交，committer、author、message 等信息。
 
## 2. 暂存区

暂存区是一个文件，路径为： `.git/index`

![](/assets/git-stage.01.bmp)

它是一个二进制文件，但是我们可以使用命令来查看其中的内容。这里我们关注第二列和第四列就可以了，第四列是文件名，第二列指的是文件的blob。这个blob存放了文件暂存时的内容。

第二列就是sha-1 hash值，相当于内容的外键，指向了实际存储文件内容的blob。第三列是文件的冲突状态，这个后面会讲，第四列是文件的路径名。

我们操作暂存区的场景是这样的，每当编辑好一个或几个文件后，把它加入到暂存区，然后接着修改其他文件，改好后放入暂存区，循环反复。直到修改完毕，最后使用 commit 命令，将暂存区的内容永久保存到本地仓库。

这个过程其实就是**构建项目快照的过程**，当我们提交时，git 会使用暂存区的这些信息生成tree对象，也就是项目快照，永久保存到数据库中。因此也可以说**暂存区是用来构建项目快照的区域**。

## 3. 文件状态

有了工作区、暂存区、本地仓库，就可以来定义文件的状态了。

![](/assets/git-file-status.png)

文件的状态可以分为两类。一类是暂存区与本地仓库比较得出的状态，另一类是工作区与暂存区比较得出的状态。为什么要分成两类的愿意也很简单，因为第一类状态在提交时，会直接写入本地仓库。而第二种则不会。一个文件可以同时拥有两种状态。

比如一个文件可能既有上面的 modified 状态，又有下面 modified 状态，但其实他们表示了不同的状态，git 会使用绿色和红色把这两中 modified 状态区分开来。


